---
title: "BACSAL_new"
author: "migs"
date: "2023_2_6"
output: html_document
---
## Loading packages
```{r, echo = T, message=FALSE}
library(readr)
library(ggplot2)
library(magrittr)
library(tidyverse)
library(ggsci)
library(ggsignif)
library(factoextra)
library(lme4)
library(lmerTest)
```

## Importing BACSAL data set
```{r, echo=T, results = 'hide'}
bsdata <- read_csv("complete_BACSAL_data.csv", show_col_types = F)
view(bsdata)
```

## Renaming long column names
```{r, echo=T, results = 'hide'}
bsdata <- bsdata %>% 
  rename(L01 = "0<.L.<=0.5000000",
         L02 = "0.5000000<.L.<=1.0000000",
         L03 = "1.0000000<.L.<=1.5000000",
         L04 = "1.5000000<.L.<=2.0000000",
         L05 = "2.0000000<.L.<=2.5000000",
         L06 = "2.5000000<.L.<=3.0000000",
         L07 = "3.0000000<.L.<=3.5000000",
         L08 = "3.5000000<.L.<=4.0000000",
         L09 = "4.0000000<.L.<=4.5000000",
         L10 = ".L.>4.5000000")
```


## Creating & converting variables
Root-shoot ratio (RTS) - the ratio of root dry biomass over shoot dry biomass)
Note: Mou et al. 2013 uses rts, has no units (dimensionless)
```{r, echo = T, results='hide'}
bsdata %>% 
  select(RootMassg, ShootMassg) %>% 
  mutate(rts = RootMassg / ShootMassg)
```
Specific Root Length (SRL) - root length divided by root dry mass
Note: Funk et al. 2016 uses units (cm / mg), while Kramer-Walter et al. 2016 uses units (m/g). Will use KW units.
```{r, echo = T, results='hide'}
bsdata %>% 
  select(Code, Lengthcm, RootMassg) %>% 
  mutate(srl = (Lengthcm/100) / RootMassg)
```
Root Tissue Density (RTD) - root mass/root volume
Note: Kramer-Walter et al. 2016 uses mg/mm^3

```{r, echo = T, results='hide'}
bsdata %>% 
  select(Code, RootMassg, RootVolcm3) %>% 
  mutate(rtd = ((RootMassg*1000)/(RootVolcm3*1000)))
```

Specific Root Area (SRA) -root area divided by dry root mass
Note: Sun et al. 2020 uses units (cm^2 / g)
```{r, echo = T, results='hide'}
bsdata %>% 
  select(Code, SurfAreacm2, RootMassg) %>% 
  mutate(sra = SurfAreacm2 / RootMassg)
```

RGRH, (relative height growth rate) according to Kramer-Walter et al. 2016, uses (ln(f)-ln(i))/(t) (BACSAL t = 35 days)
```{r, echo = T, results='hide'}
bsdata %>%
  select(Code, iHeight, fHeight) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35)
```

UNFINISHED WORK BELOW
Fine:Coarse Root Ratio -need to do some digging in McCormack 2015
Note: McCormack et al. 2015 uses arbitrary 2 mm as cutoff for fine:coarse roots ratio and questions this cutoff. Blume-Werry et al. 2017 uses log transformed fine/coarse root ratio (dimensionless).
Update Note: Maybe showing root histograms? ie, length? would be logarithmic, orders of magnitude are too greatly varied between <.5 mm and >4.5 mm

Creating histogram: 
Xaxis - Root diam. classification (from <0.5 mm to >4.5 mm)
Yaxis - root length total (log transformed?)
Group by sites (biggest source of variance), take means, and add add error bars

Root-shoot ratio, by Nitrogen
Note: Add stat significant differences between Low & High with ***
Will use independet t-test (unpaired) for now - http://www.sthda.com/english/wiki/unpaired-two-samples-t-test-in-r
```{r, echo = T, results='show'}
bsdata %>% 
  select(Code, Origin, Treatment, Water, Nitrogen, RootMassg, ShootMassg) %>% 
  mutate(rts = RootMassg / ShootMassg ) %>% 
  ggplot() +
    aes(x = factor(Origin, level = c('BOYD', 'ELFR', 'COAL')), #reorders sites
        y = rts, fill = Nitrogen) +
    geom_boxplot(na.rm = T) + #removes missing values
    ggtitle("Root-shoot ratio, grouped by Nitrogen") +
    labs(y = "Root-to-Shoot Ratio", x = "Origin, Driest > Wettest") +
    scale_fill_discrete(labels = c("High N", "Low N"))

##Trying to subset each Origin to perform Welch T Test
#BOYD
boyd_rts <- bsdata %>% 
  mutate(rts = RootMassg / ShootMassg) %>% 
  subset(Origin == "BOYD")

t.test(data = boyd_rts, rts ~ Nitrogen, paired = F)

#ELFR
elfr_rts <- bsdata %>% 
  mutate(rts = RootMassg / ShootMassg) %>% 
  subset(Origin == "ELFR")

t.test(data = elfr_rts, rts ~ Nitrogen, paired = F)

#COAL
coal_rts <- bsdata %>% 
  mutate(rts = RootMassg / ShootMassg) %>% 
  subset(Origin == "COAL")

t.test(data = coal_rts, rts ~ Nitrogen, paired = F)

#BOYD: p<0.05, p-value = 2.531e-06, ***
#ELFR: p<0.05, p-value = 5.808e-07, ***
#COAL: p<0.05, p-value = 0.002649, ***
#All ORIGIN groups are significantly different between their high and low N groups
```

Root-shoot ratio, by Origin
```{r, echo = T, results='show'}
bsdata %>%
  select(Origin, RootMassg, ShootMassg) %>% 
  mutate(rts = RootMassg / ShootMassg) %>% 
  ggplot() +
    aes(x = factor(Origin, level = c('BOYD', 'ELFR', 'COAL')),
        y = rts, fill = Origin) +
    geom_boxplot(na.rm = T) + #removes missing values
    ggtitle("Root-shoot ratio, grouped by Origin") +
    labs(y = "Root-to-Shoot Ratio",
         x = "Origin, Driest > Wettest")

#Create temp df for stats tests
origin_rts <- bsdata %>% 
  mutate(rts = RootMassg / ShootMassg)

#One-Way ANOVA to determine statistical significance + Tukey multiple pairwise-comparison
rts.aov <- aov(rts ~ Origin, data = origin_rts)
summary(rts.aov)
TukeyHSD(rts.aov)

#Note: From Tukey test, ELFR & COAL are NOT statistically significant from each other
```

According to Funk et al. 2017, a soft trait like SLA "can explain a large portion of the variation in RGR across a large range of herbaceous and woody plant species". can SRA (specific root area) do the same for root volume?
```{r, echo = T, results='show'}
#Specific Root Area by Origin
bsdata %>% 
  select(Code, Origin, SurfAreacm2, RootMassg) %>% 
  mutate(sra = SurfAreacm2 / RootMassg) %>% 
  ggplot() +
    aes(x = factor(Origin, level = c('BOYD', 'ELFR', 'COAL')),
        y = sra, fill = Origin) +
    geom_boxplot(na.rm = T) +
    scale_y_continuous(limits = c(0,1500)) +
    labs(y = "Specific Root Area (SRA) ",
         x = "Origin, Driest > Wettest")

#Create temp df for stats tests
origin_sra <- bsdata %>% 
  mutate(sra = SurfAreacm2 / RootMassg)

#One-Way ANOVA to determine statistical significance + Tukey multiple pairwise-comparison
sra.aov <- aov(sra ~ Origin, data = origin_sra)
summary(sra.aov)
TukeyHSD(sra.aov)

#Note: None of the SRA's are significantly different, ELFR & COAL are very aligned
```
SRA vs. KWRGR
```{r}
#Specific Root Area vs KW RGR
bsdata %>% 
  select(Code, Origin, SurfAreacm2, RootMassg, fHeight, iHeight) %>% 
  mutate(sra = SurfAreacm2 / RootMassg) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) %>% 
  ggplot() +
    aes(x = sra, y = kwrgr, color = Origin) +
    geom_point(na.rm = T) +
    scale_x_continuous(limits = c(0,1500)) +
    stat_ellipse(na.rm = T, 
                 lwd = 1.2) +
    labs(y = "Relative Growth Rate",
         x = "Specific Root Area (SRA)")
```


```{r, echo = T, results='show'}
#RGR vs. root diameter
bsdata %>% 
  select(Code, Origin, AvgDiammm, fHeight, iHeight) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) %>% 
  ggplot() +
    aes(x = AvgDiammm, y = kwrgr, color = Origin) +
    geom_jitter(na.rm = T) +
    scale_x_continuous(limits = c(0, 1.3)) +
    stat_ellipse(na.rm = T, 
                 lwd = 1.2) +
    labs(y = "Relative Growth Rate",
         x = "Root Average Diameter (mm)")
```

```{r, echo = T, results='show'}
#KWRGR vs. Specific Root Length
bsdata %>% 
  select(Code, Origin, Lengthcm, RootMassg, fHeight, iHeight) %>% 
  mutate(srl = (Lengthcm/100) / RootMassg) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) %>%
  ggplot() +
    aes(x = srl, y = kwrgr, color = Origin) +
    geom_point(na.rm = T) +
    scale_x_continuous(limits = c(0,100)) +
    stat_ellipse(na.rm = T, 
                 lwd = 1.2) +
    labs(y = "Relative Growth Rate",
         x = "Specific Root Length (m/g)")
```


```{r, echo = T, results='show'}
#KWrgr vs. RTD
bsdata %>% 
  select(Code, Origin, RootMassg, RootVolcm3, fHeight, iHeight) %>% 
  mutate(rtd = ((RootMassg*1000)/(RootVolcm3*1000))) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) %>% 
  ggplot() +
    aes(x = rtd, y = kwrgr, color = Origin) +
    geom_point(na.rm = T) +
    stat_ellipse(na.rm = T, 
                 lwd = 1.2) +
    labs(y = "Relative Growth Rate",
         x = "Root Tissue Density (mg/mm^3)")
```
Root-to-Shoot Ratio vs. kwrgr
```{r, echo = T, results='show'}
bsdata %>% 
  select(Code, Origin, RootMassg, ShootMassg, fHeight, iHeight) %>% 
  mutate(rts = RootMassg / ShootMassg) %>% 
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) %>% 
  ggplot() +
      aes(x = rts, y = kwrgr, color = Origin) +
      geom_point(na.rm = T) +
      stat_ellipse(na.rm = T, 
                   lwd = 1.2) +
      labs(y = "Relative Growth Rate",
         x = "Root-to-Shoot Ratio")
```

After D-Lab consultation, 2/9/23
```{r, echo = T, results='show'}
bsdatacat <- bsdata %>% 
  pivot_longer(L01:L10, names_to = 'Lcategory', values_to = 'LengthCat');

#Non-normalized
bsdatacat %>%
    ggplot() +
    aes(x = Lcategory, y = log(LengthCat+1), fill = Origin) +
    geom_boxplot(na.rm = T) +##is this counting zeroes?
    labs(y = "Root Length (log transformed)",
         x = "Root Diameter Class")
# 
# #Normalized by Total Length
# bsdatacat %>%
#   select(Code, Origin, `Length(cm)`, LengthCat, Lcategory) %>%
#  # filter(Lcategory %in% c( 'L07', 'L08', 'L09')) %>%
#   mutate(NormaLCat = LengthCat /`Length(cm)`) %>%
#     ggplot() +
#     aes(x = Lcategory, y = (NormaLCat), fill = Origin) +
#     geom_boxplot()
# #Note: graphic looks weird. Can NormaLCat be transformed by something other than log?
# 
# # Box-Cox plot might be helpful!
```

```{r, fig.width=22, fig.height=4}
#Normalized by Total Length
# bsdatacat %>%
#   select(Code, Origin, `Length(cm)`, LengthCat, Lcategory) %>% 
#  # filter(Lcategory %in% c( 'L07', 'L08', 'L09')) %>% 
#   mutate(NormaLCat = LengthCat /`Length(cm)`) %>% 
#     ggplot() +
#     aes(x = Lcategory, y = (NormaLCat), fill = Origin) +
#     geom_boxplot() +
#     facet_wrap(~Lcategory, scales = 'free', ncol = 11)
# 
# 
# bsdatacat %>% 
#   filter(Lcategory == 'L04')
```


PCA (Principal Component Analysis) - UNFINISHED
```{r, echo = T, results='show'}
##https://environmentalcomputing.net/graphics/multivariate-vis/pca/
# 
# Origin <- bsdata$Origin
# 
# Root_data <- bsdata[, "Root Mass (g)", "RootVolume(cm3)", "SurfArea(cm2)"]
# 
# Root_PCA <- princomp(Root_data, cor = F)
# 
# plot(Root_PCA$scores, pch = 16, col = as.factor(Origin))

```


Using PRComp
```{r, echo = T, results='show'}
#http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/118-principal-component-analysis-in-r-prcomp-vs-princomp/#compute-pca-in-r-using-prcomp

Origin <- bsdata$Origin

#Add in all created traits, remove all missing values
bsdata_complete <- bsdata %>% 
  #filter(complete.cases(.)) %>% #removes almost ALL rows! ???
  mutate(rts = RootMassg / ShootMassg) %>% #Root-to-Shoot
  mutate(srl = (Lengthcm/100) / RootMassg) %>% 
  mutate(sra = SurfAreacm2 / RootMassg) %>% #SRA
  mutate(rtd = ((RootMassg*1000)/(RootVolcm3*1000))) %>% #RTD
  mutate(kwrgr = ((log(fHeight)) - (log(iHeight)))/35) #RGR

#Select relevant root variables
Root_data <- bsdata_complete %>% 
  select(Lengthcm, RootMassg, RootVolcm3, SurfAreacm2, ShootMassg,
         AvgDiammm, rts, srl, sra, kwrgr, rtd)

#cor(Root_data, use = 'complete.obs') #checking each trait's correlation

Root_PCA <- prcomp(na.omit(Root_data), scale = T) #scale = T is if they have different units, and na.omit ignores NA values

fviz_eig(Root_PCA)

fviz_pca_biplot(Root_PCA, 
                repel = T, #Avoid text overlapping
                col.ind = "black", # Individuals
                alpha.ind = 0, #turns individuals invisible
                addEllipses = T,
                col.var = "#2E9FDF" # Variables color
                )

?fviz_pca_biplot #help
#dim1 is the 'new' set of variables created. Variables are SO highly correlated, PCA collapses them into ONE variable. 
#https://setosa.io/ev/principal-component-analysis/

#note: this looks messy. Could we clean it up?
```

LME4 Analysis
```{r, echo = T, results='show'}
bsdata <- bsdata %>% 
  rename(Length = 'Length(cm)')

mod <- lmer(Length ~ Origin + Water*Nitrogen + (1 | Genotype), data = bsdata)

summary(mod)
anova(mod)


#change genotype to parent (F2B, M1B, etc.)

```



















